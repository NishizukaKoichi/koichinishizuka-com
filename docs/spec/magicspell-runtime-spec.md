# MagicSpell Runtime

完成仕様書（Fixed Specification）

## 1. これは何か

**MagicSpell Runtime は、処理を実行するためのランタイムではない。**  
**処理の実行前に、必ず MagicSpell に実行可否を問い合わせさせるための実行枠組み**。

・処理は第三者が作る  
・環境も第三者が持つ  
・Runtime は「勝手に動かない殻」

---

## 2. Runtime がやること（これだけ）

実行要求が来たら、必ず以下を行う。

1. MagicSpell に Scope Check を送る  
2. 返答を待つ  
3. `allowed = true` のときのみ処理を実行  
4. それ以外は即終了（fail-closed）

これ以外の判断は存在しない。

---

## 3. Runtime がやらないこと（重要）

・課金しない  
・価格を知らない  
・回数を数えない  
・利用者を識別しない（識別子を運ぶだけ）  
・処理内容を検査しない  
・ログを分析しない  
・再試行しない  
・例外を握りつぶさない

**Runtime に裁量は一切ない。**

---

## 4. 技術的成立条件（最小）

Runtime が満たしていればよい条件はこれだけ。

・第三者の環境（Vercel）で動く  
・ビルド済みアーティファクトとして配布可能  
・実行前に必ず Scope Check を行う  
・MagicSpell に接続できない場合は fail-closed  
・Scope Check をスキップする経路が存在しない

言い換えると、  
**MagicSpell を通らずに処理が走る経路が一つも無いこと**。

---

## 5. セキュリティと支配点

・Runtime はコピーされてよい  
・Runtime は改変されてもよい  
・それでも Entitlement がなければ無力

支配点は Runtime ではなく  
**MagicSpell 側の Entitlement と API Key**。

Key を失効させれば、  
世界中にデプロイされた Runtime が同時に沈黙する。

---

## 6. 責任分離（再確認）

・処理の責任 → 第三者  
・実行環境の責任 → 第三者  
・実行可否の責任 → MagicSpell  
・結果の責任 → 誰も取らない

MagicSpell は  
**「許可したかどうか」以外の責任を一切負わない**。

---

## 7. Done 定義（完成条件）

以下が成立していれば、MagicSpell Runtime は完成。

・第三者が任意の処理を組み込める  
・第三者が自分の環境にデプロイできる  
・実行前に必ず Scope Check が走る  
・Yes / No 以外の分岐が存在しない  
・MagicSpell 側の変更なしで Spell を増やせる

これ以上、**足すものはない**。

---

## 最終確定文

> **MagicSpell Runtime は、  
> 第三者が作った処理を、第三者の環境で実行させる際に、  
> 実行の瞬間だけを中央の Yes / No に従属させるための殻である。**

処理は自由。  
実行は従属。  
判断は一箇所。

ここまでで **MagicSpell Runtime は完成**。  
次にやることは設計ではなく、**使われる回数を増やすことだけ**。
