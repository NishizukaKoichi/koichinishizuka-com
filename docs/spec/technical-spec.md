# Epoch 技術仕様書

Version 1.2
Status: Final / Implementation-Complete Spec

## 1. 基本定義
Epoch は、人の判断と行為を評価・解釈・最適化せず、不可逆な時間の層として記録・保存するプロダクトである。
Epoch が扱うのは「事実が起きたこと」「起きなかったこと」のみであり、意味づけは時間に委ねられる。

## 2. 絶対原則
以下は破ってはならない。

- 履歴は削除できない
- 履歴は書き換えられない
- 時間順序は絶対
- 評価・スコア・要約を行わない
- 沈黙も履歴として扱う
- クライアントの違いで意味が変わらない

UX、成長、利便性はこれらを侵害しない限りにおいてのみ許可される。

## 3. クライアント前提（Web / Mobile 共通）
Epoch における真実は、常にサーバ側にのみ存在する。

- Web クライアント
- Mobile クライアント（PWA / ネイティブ想定）

いずれも入力と閲覧のための端末であり、履歴の意味や状態を保持しない。
ローカルに許可されるのは下書き（draft）のみ。

## 4. システム構成（論理）

Client Layer
- Web UI
- Mobile UI
- 下書きローカル保持

Application Layer
- 認証
- EpochRecord 書き込み制御
- 可視性制御
- 読み取り課金制御
- 署名検証

Persistence Layer
- 不可逆 Record Store
- Record Index
- プロフィール表層データ
- 課金／購読情報
- 監査ログ

分析、推薦、通知基盤は原則持たない。

## 5. ユーザーと認証

### 5.1 User の定義
User は人格ではなく履歴の主体である。

User が持つ属性
- user_id（UUIDv7 推奨）
- created_at
- auth_credentials

複数 User の統合は禁止。

### 5.2 認証方式
- Passkey（WebAuthn）を第一優先
- Email + Magic Link は補助
- OAuth は原則使用しない

スマホでは OS 認証器（Face ID / Touch ID 等）を利用可能。
認証は本人確認のためだけに存在し、評価や信頼付与には使われない。

### 5.3 認証復旧
- ログイン状態でのみ passkey 追加可
- ログイン不能時はメール復旧のみ
- 復旧が行われた事実は EpochRecord として記録
- 運営者の手動介入は禁止

## 6. EpochRecord（不可逆履歴）

### 6.1 基本構造
EpochRecord は不可変イベント。

必須フィールド
- record_id
- user_id
- recorded_at（UTC、サーバ時刻のみ）
- record_type
- payload
- prev_hash
- record_hash

クライアント時刻は使用しない。

### 6.2 record_type（初期固定）
- decision_made
- decision_not_made
- invited
- declined
- revised
- period_of_silence
- auth_recovered

追加は可能だが、意味変更は禁止。

### 6.3 payload 制約
payload は JSON。

禁止
- 評価語、感情語
- 成功／失敗判定
- 他 record の意味を書き換える参照

payload は事実の記述に限定。

## 7. 画像・メディア添付

### 7.1 Record 添付画像
- 画像は EpochRecord に付随する attachment としてのみ存在
- テキスト payload を必須とする
- 画像単体 record の作成は禁止

技術制約
- immutable storage（差し替え不可）
- attachment_hash を record_hash に含める
- EXIF 時刻は信用しない

画像は証拠補助であり、意味を定義しない。

### 7.2 動画
v1 では禁止。

## 8. プロフィール情報（表層データ）

### 8.1 プロフィール画像
- デフォルトは認証アカウント由来の avatar
- 取得不可の場合は抽象プレースホルダー
- ユーザーは任意で画像変更可能

制約
- EpochRecord を生成しない
- 変更履歴を残さない
- 評価、検索、課金に関与しない
- record_hash とは無関係

プロフィール画像は履歴を持たない表層データである。

### 8.2 その他プロフィール
- 表示名（mutable）
- 短い自己紹介（任意）

いずれも履歴性を持たない。

## 9. 公開範囲制御
各 record は以下の可視性を持つ。

- private
- scout_visible（URL 保持者）
- public

可視性変更は状態変更 record として追記され、過去は書き換えない。

## 10. オフライン動作
- オフライン確定は禁止
- オフライン下書きのみ許可
- 確定は常にオンラインかつサーバ時刻

## 11. 読み取りと課金

### 11.1 課金対象
- 自分の Epoch 閲覧は無料
- 他人の Epoch を判断材料として読む場合のみ課金

### 11.2 課金単位
許可
- Time Window
- Read Session

禁止
- Record 単体課金
- 評価連動課金

### 11.3 無料復帰
課金停止後も書き込みと自己閲覧は継続可能。

## 12. スカウト機構
スカウトは Epoch 外部イベント。

文言固定
「一回来て、仕事を一緒にやってみませんか？」

自由記述は禁止。
送信、受信、承諾、拒否は双方の Epoch に事実として記録される。

## 13. 通知方針
原則通知なし。例外としてスカウト受信のみ通知可。

## 14. 禁止事項
以下は実装しない。

- 全文検索
- AI 要約
- ランキング
- スコア
- おすすめ

意味の圧縮は評価を生むため。

## 15. 監査と運営権限
- 全操作は監査ログに記録
- 運営者操作も同様
- 運営者は record の削除・修正不可

## 16. 終了とデータエクスポート
サービス終了時
- 全履歴をそのままエクスポート可能
- 意味変換、再構成は禁止

Epoch は消える前提で設計される。

## 17. 実装完了定義（最終）
以下を満たした時点で Epoch v1 は完成とする。

- 不可逆 Record 書き込みが稼働
- Web / Mobile が同一仕様で動作
- オフラインは draft のみ
- 画像添付が record に従属して機能
- プロフィール画像は表層データとして分離
- 読み取り課金が機能
- 削除／編集 API が存在しない
- 運営者でも履歴改変不可
